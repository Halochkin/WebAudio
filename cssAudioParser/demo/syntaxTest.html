<style>
    :root {
        --audio-test: "gain([0.9/0.9, 0.6/0.001, 0.6/0.4, 0/0.02])";
    }
</style>
<script type="module">
  import {parse} from "../src/cssAudioParser.js";
  import {interpret} from "../src/cssAudioInterpreter.js";

  let a = "a > b > c";
  let a_ = '{"type":"pipe","nodes":["a","b","c"]}';

  let b = "a > --audio-var > c";
  let b_ = '{"type":"pipe","nodes":["a","--audio-var","c"]}';

  let c = "a > b > [c, d]";
  let c_ = '{"type":"pipe","nodes":["a","b",["c","d"]]}';

  let d = "sawtooth(144hz) > lowpass(140hz, 24dB)";
  let d_ = '{"type":"pipe","nodes":[{"type":"fun","name":"sawtooth","args":[{"num":"144","unit":"hz"}]},{"type":"fun","name":"lowpass","args":[{"num":"140","unit":"hz"},{"num":"24","unit":"dB"}]}]}';

  let e = "square(144hz) > gain([1/0.0015],[0.6/0.001],[0.6/1],[0/0.03]) > lowpass(180hz, 12dB)";
  let e_ = '{"type":"pipe","nodes":[{"type":"fun","name":"square","args":[{"num":"144","unit":"hz"}]},{"type":"fun","name":"gain","args":[[[{"num":"1","unit":""},{"num":"0.0015","unit":""}]],[[{"num":"0.6","unit":""},{"num":"0.001","unit":""}]],[[{"num":"0.6","unit":""},{"num":"1","unit":""}]],[[{"num":"0","unit":""},{"num":"0.03","unit":""}]]]},{"type":"fun","name":"lowpass","args":[{"num":"180","unit":"hz"},{"num":"12","unit":"dB"}]}]}';

  let f = "url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3)";
  let f_ = '{"type":"pipe","nodes":[{"type":"fun","name":"url","args":["https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3"]}]}';

  let g = "url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3) > lowpass(180hz, 12dB)";
  let g_ = '{"type":"pipe","nodes":[{"type":"fun","name":"url","args":["https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3"]},{"type":"fun","name":"lowpass","args":[{"num":"180","unit":"hz"},{"num":"12","unit":"dB"}]}]}';

  let h = "url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3) > gain([1/0.0015],[0.6/0.001],[0.6/1],[0/0.03]) > lowpass(180hz, 12dB)";
  let h_ = '{"type":"pipe","nodes":[{"type":"fun","name":"url","args":["https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3"]},{"type":"fun","name":"gain","args":[[[{"num":"1","unit":""},{"num":"0.0015","unit":""}]],[[{"num":"0.6","unit":""},{"num":"0.001","unit":""}]],[[{"num":"0.6","unit":""},{"num":"1","unit":""}]],[[{"num":"0","unit":""},{"num":"0.03","unit":""}]]]},{"type":"fun","name":"lowpass","args":[{"num":"180","unit":"hz"},{"num":"12","unit":"dB"}]}]}';

  let i = "url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3) > [a, b]";
  let i_ = '{"type":"pipe","nodes":[{"type":"fun","name":"url","args":["https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3"]},["a","b"]]}';

  let j = "triangle(144hz) > peaking(120hz, 25dB, 10hz)";
  let j_ = '{"type":"pipe","nodes":[{"type":"fun","name":"triangle","args":[{"num":"144","unit":"hz"}]},{"type":"fun","name":"peaking","args":[{"num":"120","unit":"hz"},{"num":"25","unit":"dB"},{"num":"10","unit":"hz"}]}]}';

  let k = "noise > bandpass(140hz, 12dB, 300hz)";
  let k_ = '{"type":"pipe","nodes":["noise",{"type":"fun","name":"bandpass","args":[{"num":"140","unit":"hz"},{"num":"12","unit":"dB"},{"num":"300","unit":"hz"}]}]}';

  let l = 'noise > gain([0.9/0.9, 0.6/0.001, 0.6/0.4, 0/0.02]) > peaking(120hz, 25dB, 100hz)';
  let l_ = '{"type":"pipe","nodes":["noise",{"type":"fun","name":"gain","args":[[[{"num":"0.9","unit":""},{"num":"0.9","unit":""}],[{"num":"0.6","unit":""},{"num":"0.001","unit":""}],[{"num":"0.6","unit":""},{"num":"0.4","unit":""}],[{"num":"0","unit":""},{"num":"0.02","unit":""}]]]},{"type":"fun","name":"peaking","args":[{"num":"120","unit":"hz"},{"num":"25","unit":"dB"},{"num":"100","unit":"hz"}]}]}';

  let m = 'a > --audio-var > peaking(120hz, 25dB, 1hz)';
  let m_ = '{"type":"pipe","nodes":["a","--audio-var",{"type":"fun","name":"peaking","args":[{"num":"120","unit":"hz"},{"num":"25","unit":"dB"},{"num":"1","unit":"hz"}]}]}';

  function test(msg, tst) {
    let obj = parse(msg);
    let stringify = JSON.stringify(obj);
    if (tst === stringify)
      console.log("success: ", msg, obj);
    else
      console.error("error: ", msg, obj);
  }

  test(a, a_);
  test(b, b_);
  test(c, c_);
  test(d, d_);
  test(e, e_);
  test(f, f_);
  test(g, g_);
  test(h, h_);
  test(i, i_);
  test(j, j_);
  test(k, k_);
  test(l, l_);
  test(m, m_);

  async function onClick() {
//    let x = "sine(340hz) > gain(0.2)"; //works
//    let x = "sine(340hz) > gain(square(2hz))"; //works
//    let x = "sine(340hz) > gain([0.9/0.9, 0.6/0.001, 0.6/0.4, 0/0.02])"; //works
//    let x = "noise";
//    let x = "url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3) > gain([1/0.0015],[0.3/0.3],[0.6/1.1],[0/1.2]) > lowpass(180hz, 12dB)";
    let x = "a > --audio-var > peaking(120hz, 25dB, 1hz)";
    const ctx = await interpret(x);
//    const ctx = await interpret(g);
    ctx.resume();
    setTimeout(function () {
      ctx.suspend();
    }, 2000);
  }

  window.addEventListener("click", onClick);

  //  async function onClick2(e){
  //    e.stopPropagation();
  //    const buffer = await interpret2(g);
  //    const audioCtx = new AudioContext();
  //    const bufferSource = audioCtx.createBufferSource();
  //    bufferSource.buffer = buffer;
  //    bufferSource.connect(audioCtx.destination);
  //    setTimeout(function(){
  //      audioCtx.suspend();
  //    }, 4000);
  //  }
  //  document.querySelector("pre").addEventListener("click", onClick2);
</script>

<pre>here the beautiful sounds! (sic.)</pre>